---
title:  "Using SPICT for surplus production model fitting"
format: html
editor: visual
---

```{r}
#| label: load-packages
#| include: false

library(tidyverse)
library(palmerpenguins)
theme_set(theme_minimal())
```

# SPICT

SPiCT is a model of 'Surplus Production in Continuous Time', implemented in the 'spict' R package, found [here](https://github.com/DTUAqua/spict). It is relatively easy to implement and comes with a lot of powerful diagnostic tools, but should be used with caution because even if a model is created, it may be unusable due to high levels of uncertainty. In this session, we are mainly going to work from the above web page, and follow instructions there on how to install the package, and follow the vignette to learn its functionality. The website also has a link to [technical guidelines](https://raw.githubusercontent.com/DTUAqua/spict/master/spict/inst/doc/spict_guidelines.pdf) on how to judge whether the model created is trustworthy and informative. Here some points to keep in mind from the technical guidelines:

### Main assumptions and input data

-   Catch should be representative of total removals from the population and aligned correctly in timing

-   Stock size indices should be in terms of biomass (not numbers) and represent exploitable stock biomass. Timing should be correctly aligned.

### Checklist for the acceptance of a SPiCT assessment

-   assessment converged

-   All variance parameters are finite

-   No violation of model assumptions based on one-step-ahead residuals (e.g., no bias or auto-correlation should be present to violate normality assumptions).

-   There should be no tendency of consistent uner- or overestimation of fishing mortality or biomass in successive assessments

-   Realistic production curve (not too skewed)

-   Assessment uncertainty is not too high (not span more than 1 order of magnitude)

-   initial values do not influence parameter estimates

With this in mind, let's install and try a vignette.

### Independent exercise

Want to try fitting a SPiCT model on your own? Here are some data from our common whelk example and how to format them so that they can be used in with spict package functions. Then just run the model and plot!

```{r, echo = TRUE}
#### whelk ex. Download data files from the advice page for Common whelk at hafogvatn.is.
library(spict)
WHE_landings <- read_csv('data/WHE_landings.csv')
WHE_assessment <- read_csv('data/WHE_assessment.csv')

whelk.data <- 
  WHE_landings %>% 
  group_by(year) %>% 
  summarise(landings = sum(landings))  %>% 
  bind_rows(tibble(year=2020, landings=0)) %>%  
  left_join(WHE_assessment) %>% 
  rename(YY = year, II = `biomass index`, CC = landings) %>% 
  filter(YY > 2003) |> 
  arrange(YY)

whelk <- NULL
whelk$obsC <- whelk.data$CC
whelk$timeC <- whelk$timeI <- whelk.data$YY
whelk$obsI <- whelk.data$II

inp <- check.inp(whelk)
inp
```

```{r}
plotspict.data(inp)

```

```{r}
plotspict.ci(inp)

```

```{r}
res <- fit.spict(inp)
names(res)
res$opt
```

```{r}
summary(res)
```

```{r}
plot(res)
```

Would this model tick all boxes in the checklist and be acceptable? What could be done make the model better? Try taking a second look at the [technical guidelines](https://raw.githubusercontent.com/DTUAqua/spict/master/spict/inst/doc/spict_guidelines.pdf). These technical guidelines will refer to "residuals", which are standardly used across all statistical modelling frameworks to understand how well a model fits a set of data.

### Review: residuals demonstration

Here we start out with some fake data again, to demonstrate that a linear model indeed fit the patterns in the data when the data being generated are from a linear process. The residuals, which is the difference between observed and predicted values, look like random noise along the whole range of data.

```{r}

xx <- c(1:200)  
yy <- 1:200 + rnorm(200, sd = 10)

test.lm <- lm(yy~xx)
plot(yy~xx)
abline(coef(test.lm))
residuals(test.lm)

qqnorm(residuals(test.lm))
qqline(residuals(test.lm))

hist(residuals(test.lm))
hist(rnorm(200,sd = 10))


```

And when the underlying data was generated by a pattern other than a line, patterns persist in the residuals:

```{r}

xx <- c(1:200) + c(1:200)^3 
yy <- 1:200 + rnorm(200, sd = 10)

test.lm <- lm(yy~xx)
plot(yy~xx)
abline(coef(test.lm))

qqnorm(residuals(test.lm))
qqline(residuals(test.lm))

hist(residuals(test.lm))
hist(rnorm(200,sd = 10))

```

The same principles apply when looking at more complex models, such as non-linear models like SPICT. The model is considered to fit the data well when there patterns in the residuals appear random. The diagnostics plots below check to determine whether residuals are:

-   (second row of plots): normally distributed around a slope of 0 along the full time series

-   (third row of plots): independentally and identically distributed (iid), especially with regards to autocorrelation (i.e., there should be no autocorrelation along the time series)

-   (fourth row of plots): normally distributed along the full range of minimum -\> maximum values

Further diagnostics aim to show how consistent the model estimation is from year to year, and whether there is any consistent over- or under-estimation (retrospective analysis, with bias measured by a Mohn's rho statistic).

```{r}
pres <- calc.process.resid(res)
plotspict.diagnostic.process(pres)

retrores <- retro(res, nretroyear = 4, mc.cores = 1)
plotspict.retro(retrores)

```

### Review: residuals demonstration

When there is not a lot of contrast in the data, or the data are highly variable, some assumptions may be needed to constrain the optimization. For example, the whelk model used for assessment at the MFRI is constrained to have a symmetrical surplus production curve, thereby assuming a Schaeffer model. Other changes include:

-   changing the priors for several parameters

-   constraining the ratio between observation and process error to be 1 (i.e., forcing them to be equal) for both the biomass model and the fishing model

-   Phasing the estimation so certain parameters are estimating before others.

Can you see in the code below where these are implemented?

```{r}
#-----------Adding settings from the actual assessment--------#
# Priors from Pamela Woods, Jónas Páll Jonasson,
# Bayesian hierarchical surplus production model of the common whelk Buccinum undatum in Icelandic waters,
# Fisheries Research,
# Volume 194,
# 2017,
# Pages 117-128,
# ISSN 0165-7836,
# https://doi.org/10.1016/j.fishres.2017.05.011.
# (https://www.sciencedirect.com/science/article/pii/S0165783617301388)

# A prior is set using
list.possible.priors()

inp$priors$logK <- c(log(3*2500 + 2*3500 + 4000), sqrt(0.0924), 1)
inp$priors$logr <- c(log(0.0753), sqrt(0.0342), 1)
inp$priors$logbkfrac<-c(log(0.4674),sqrt(0.0102),1)
#inp$priors$logq <- c(log(0.1196), sqrt(0.0650),1)

inp$priors$logalpha=c(1,1,0) # deactivate
inp$priors$logbeta=c(1,1,0) # deactivate
inp$priors$logn <- c(1, 1, 0) # deactivate
inp$phases$logsdb <- -1
inp$phases$logn= -1

inp$ini$logsdb <- log(0.1)
inp$priors$logsdf=c(log(3), 0.5, 1) # process noise of F
inp$priors$logsdc=c(log(0.1), 0.2, 1) # observation noise Catch

res<-fit.spict(inp)
summary(res)
plot(res)

# Diagnostics plot

res1<- calc.osa.resid(res)
plotspict.diagnostic(res1)

#retro figures

res2 <- spict::retro(res, nretroyear = 5, mc.cores = 1)
plotspict.retro(res2)

mohns_rho(res2, what = c("FFmsy", "BBmsy"))

```

### 
