<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.542">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>PopModels - Fitting a logistic curve</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">PopModels</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#logistic-growth---review" id="toc-logistic-growth---review" class="nav-link active" data-scroll-target="#logistic-growth---review">Logistic growth - review</a>
  <ul class="collapse">
  <li><a href="#fitting-a-logistic-growth-curve-to-elephant-data" id="toc-fitting-a-logistic-growth-curve-to-elephant-data" class="nav-link" data-scroll-target="#fitting-a-logistic-growth-curve-to-elephant-data">Fitting a logistic growth curve to elephant data</a></li>
  <li><a href="#exercise" id="toc-exercise" class="nav-link" data-scroll-target="#exercise">Exercise</a></li>
  <li><a href="#take-home-messages" id="toc-take-home-messages" class="nav-link" data-scroll-target="#take-home-messages">TAKE HOME MESSAGES</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Fitting a logistic curve</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="logistic-growth---review" class="level2">
<h2 class="anchored" data-anchor-id="logistic-growth---review">Logistic growth - review</h2>
<p>Remember this equation from the Simple Population Models section?</p>
<p><span class="math inline">\(N_t = N_{t-1} + rN_{t-1}(1-N_{t-1}/K)\)</span></p>
<p>Let’s review.</p>
<ul>
<li><p>What is the functional form?</p></li>
<li><p>What are the parameters?</p></li>
<li><p>What does each parameter control?</p></li>
</ul>
<section id="fitting-a-logistic-growth-curve-to-elephant-data" class="level3">
<h3 class="anchored" data-anchor-id="fitting-a-logistic-growth-curve-to-elephant-data">Fitting a logistic growth curve to elephant data</h3>
<p>In this section, building on the basics we have learned on how statistical models are fit, we are going to fit a non-linear model. The model describes logistic growth of an elephant population. Note: here we use sum of squares as our objective function, which is not the best way to fit a non-linear model, but is used for demonstration.</p>
<p>Take a look at <a href="https://ecosystem-project.com/epopulationgrowth">this website</a> below to get familiar with the system. Then continue with the exercise.</p>
</section>
<section id="exercise" class="level3">
<h3 class="anchored" data-anchor-id="exercise">Exercise</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>Yrs<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">1903</span>, <span class="dv">1905</span>, <span class="dv">1907</span>, <span class="dv">1926</span>, <span class="dv">1928</span>, <span class="dv">1932</span>, <span class="dv">1935</span>, <span class="dv">1939</span>, <span class="dv">1946</span>, <span class="dv">1948</span>, <span class="dv">1961</span>, <span class="dv">1964</span>, <span class="dv">1967</span>, <span class="dv">1970</span>, <span class="dv">1972</span>, <span class="dv">1974</span>, <span class="dv">1976</span>, <span class="dv">1979</span>, <span class="dv">1982</span>, <span class="dv">1985</span>, <span class="dv">1988</span>, <span class="dv">1990</span>, <span class="dv">1993</span>, <span class="dv">1996</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>Data<span class="ot">&lt;-</span><span class="fu">c</span>(<span class="dv">12</span>, <span class="dv">15</span>, <span class="dv">17</span>, <span class="dv">25</span>, <span class="dv">27</span>, <span class="dv">30</span>, <span class="dv">37</span>, <span class="dv">42</span>, <span class="dv">52</span>, <span class="dv">108</span>, <span class="dv">156</span>, <span class="dv">219</span>, <span class="dv">7563</span>, <span class="dv">8642</span>, <span class="dv">7378</span>, <span class="dv">7245</span>, <span class="dv">6983</span>, <span class="dv">7367</span>, <span class="dv">7689</span>, <span class="dv">8503</span>, <span class="dv">7654</span>, <span class="dv">6803</span>, <span class="dv">7204</span>, <span class="dv">7343</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(Yrs); <span class="fu">length</span>(Data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 24</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 24</code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#pars, Years, and Numbers are vector arguments</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>LogisticGrowthModel<span class="ot">&lt;-</span><span class="cf">function</span>(pars, Years, Numbers, <span class="at">ReturnResults=</span>F){</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">#print(Years)</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  KK<span class="ot">&lt;-</span>pars[<span class="dv">1</span>]; rr<span class="ot">&lt;-</span>pars[<span class="dv">2</span>]; BB<span class="ot">&lt;-</span>pars[<span class="dv">3</span>]<span class="co">#assign parameters</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  TT<span class="ot">&lt;-</span>Years[<span class="dv">1</span>]<span class="sc">:</span>Years[<span class="fu">length</span>(Years)] <span class="co">#stretch out years within model so no missing years</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">#print(TT)</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  PP<span class="ot">&lt;-</span><span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">"numeric"</span>, <span class="at">length =</span> <span class="fu">length</span>(TT));  <span class="co">#empty population size vector</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  DD<span class="ot">&lt;-</span><span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">"numeric"</span>, <span class="at">length =</span> <span class="fu">length</span>(TT)); <span class="co">#empty population growth vector</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>  II<span class="ot">&lt;-</span>rr<span class="sc">*</span>BB<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>BB<span class="sc">/</span>KK) <span class="co">#initial growth to reach year 1 from year 0</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>  PP[<span class="dv">1</span>]<span class="ot">&lt;-</span>BB<span class="sc">+</span>II <span class="co"># population assignment at year 1, based on parameter BB (initial population)</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(PP)){ </span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    DD[i<span class="dv">-1</span>] <span class="ot">&lt;-</span> rr<span class="sc">*</span>PP[i<span class="dv">-1</span>]<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>PP[i<span class="dv">-1</span>]<span class="sc">/</span>KK); <span class="co">#this is dN/dt - amount the population grows based</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">#on conditions in the previous time step</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    PP[i] <span class="ot">&lt;-</span> PP[i<span class="dv">-1</span>] <span class="sc">+</span> DD[i<span class="dv">-1</span>] <span class="co">#update population size</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    } </span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>  <span class="co">#print(DD)</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>  <span class="co">#print(PP)</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>   Predictions<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="at">Years =</span> TT, <span class="at">Pred =</span> PP); <span class="co">#create predictions</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>   Observations<span class="ot">&lt;-</span><span class="fu">data.frame</span>(Years, Numbers) <span class="co">#store observations in data frame</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>   Results<span class="ot">&lt;-</span><span class="fu">merge</span>(Predictions, Observations, <span class="at">by =</span> <span class="st">"Years"</span>) <span class="co">#match Predictions and Observations by Year</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>   SS<span class="ot">&lt;-</span><span class="fu">sum</span>((Results<span class="sc">$</span>Numbers <span class="sc">-</span> Results<span class="sc">$</span>Pred)<span class="sc">^</span><span class="dv">2</span>) <span class="co">#calculate sum of squares: sum((obs - pred)^2)</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>   <span class="co">#print('Results')</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>   <span class="co">#print(Results)</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(ReturnResults<span class="sc">==</span>T){ <span class="fu">return</span>(<span class="fu">list</span>(Predictions, SS))} <span class="cf">else</span> {<span class="fu">return</span>(SS)}</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>   <span class="co">#controls options for what is returned from function</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>   }</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a><span class="co">#LogisticGrowthModel(c(7500,0.5), Yrs, Data, t=0, ReturnResults=T) ERROR</span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a><span class="fu">LogisticGrowthModel</span>(<span class="fu">c</span>(<span class="dv">7500</span>,<span class="fl">0.5</span>,<span class="dv">1</span>), <span class="at">Years=</span>Yrs, <span class="at">Numbers=</span>Data, <span class="at">ReturnResults=</span>T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
   Years        Pred
1   1903    1.499933
2   1904    2.249750
3   1905    3.374288
4   1906    5.060672
5   1907    7.589301
6   1908   11.380112
7   1909   17.061534
8   1910   25.572895
9   1911   38.315744
10  1912   57.375743
11  1913   85.844149
12  1914  128.274942
13  1915  191.315449
14  1916  284.533067
15  1917  421.402329
16  1918  620.264832
17  1919  904.748684
18  1920 1302.551681
19  1921 1840.718129
20  1922 2535.194312
21  1923 3374.310788
22  1924 4302.401296
23  1925 5219.558149
24  1926 6013.084739
25  1927 6609.147903
26  1928 7001.666121
27  1929 7234.277284
28  1930 7362.431404
29  1931 7429.954028
30  1932 7464.649918
31  1933 7482.241650
32  1934 7491.099801
33  1935 7495.544620
34  1936 7497.770987
35  1937 7498.885162
36  1938 7499.442498
37  1939 7499.721228
38  1940 7499.860609
39  1941 7499.930303
40  1942 7499.965151
41  1943 7499.982576
42  1944 7499.991288
43  1945 7499.995644
44  1946 7499.997822
45  1947 7499.998911
46  1948 7499.999455
47  1949 7499.999728
48  1950 7499.999864
49  1951 7499.999932
50  1952 7499.999966
51  1953 7499.999983
52  1954 7499.999991
53  1955 7499.999996
54  1956 7499.999998
55  1957 7499.999999
56  1958 7499.999999
57  1959 7500.000000
58  1960 7500.000000
59  1961 7500.000000
60  1962 7500.000000
61  1963 7500.000000
62  1964 7500.000000
63  1965 7500.000000
64  1966 7500.000000
65  1967 7500.000000
66  1968 7500.000000
67  1969 7500.000000
68  1970 7500.000000
69  1971 7500.000000
70  1972 7500.000000
71  1973 7500.000000
72  1974 7500.000000
73  1975 7500.000000
74  1976 7500.000000
75  1977 7500.000000
76  1978 7500.000000
77  1979 7500.000000
78  1980 7500.000000
79  1981 7500.000000
80  1982 7500.000000
81  1983 7500.000000
82  1984 7500.000000
83  1985 7500.000000
84  1986 7500.000000
85  1987 7500.000000
86  1988 7500.000000
87  1989 7500.000000
88  1990 7500.000000
89  1991 7500.000000
90  1992 7500.000000
91  1993 7500.000000
92  1994 7500.000000
93  1995 7500.000000
94  1996 7500.000000

[[2]]
[1] 471423138</code></pre>
</div>
</div>
<p>Now we would like to fit this model by minimizing the objective function using algorithms implemented in the ‘optim’ function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>?optim</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co"># this function tries different parameter values to minimize the output of </span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co">#LogisticGrowthModel. The output is the sum of squares.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>OptPars1<span class="ot">&lt;-</span><span class="fu">optim</span>(<span class="fu">c</span>(<span class="dv">7500</span>,<span class="fl">0.5</span>,<span class="dv">1</span>), LogisticGrowthModel, <span class="at">method =</span> <span class="st">'L-BFGS-B'</span>, <span class="at">Years =</span> Yrs, <span class="at">Numbers =</span> Data, <span class="at">lower =</span> <span class="fu">c</span>(<span class="dv">2000</span>, <span class="dv">0</span>,<span class="fl">0.8</span>), <span class="at">upper =</span> <span class="fu">c</span>(<span class="dv">10000</span>, <span class="dv">1</span>,<span class="dv">100</span>), <span class="at">control =</span> <span class="fu">list</span>(<span class="at">maxit =</span> <span class="dv">50000</span>))</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>OptPars1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$par
[1] 8040.6746970    0.1581262    0.8000000

$value
[1] 42519063

$counts
function gradient 
      60       60 

$convergence
[1] 0

$message
[1] "CONVERGENCE: REL_REDUCTION_OF_F &lt;= FACTR*EPSMCH"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>OptPars2<span class="ot">&lt;-</span><span class="fu">optim</span>(<span class="fu">c</span>(<span class="dv">7500</span>,<span class="fl">0.5</span>,<span class="dv">1</span>), LogisticGrowthModel, <span class="at">Years =</span> Yrs, <span class="at">Numbers =</span> Data, <span class="at">control =</span> <span class="fu">list</span>(<span class="at">maxit =</span> <span class="dv">50000</span>))</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>OptPars2</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$par
[1] 7.529675e+03 1.835725e+00 5.138202e-26

$value
[1] 3428472

$counts
function gradient 
    2531       NA 

$convergence
[1] 0

$message
NULL</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>Predictions1<span class="ot">&lt;-</span><span class="fu">LogisticGrowthModel</span>(OptPars1<span class="sc">$</span>par, Yrs, Data, <span class="at">ReturnResults=</span>T)[[<span class="dv">1</span>]]</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>Predictions2<span class="ot">&lt;-</span><span class="fu">LogisticGrowthModel</span>(OptPars2<span class="sc">$</span>par, Yrs, Data, <span class="at">ReturnResults=</span>T)[[<span class="dv">1</span>]]</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co">#tibble(Yrs, Data) %&gt;% </span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co">#  ggplot(aes(Yrs, Data)) + geom_point(shape = '*', color = 'red', size = 5) + ylim(0,8000)</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(Yrs, Data) <span class="sc">%&gt;%</span> </span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(Yrs, Data)) <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="at">shape =</span> <span class="st">'*'</span>, <span class="at">color =</span> <span class="st">'red'</span>, <span class="at">size =</span> <span class="dv">5</span>) <span class="sc">+</span> <span class="fu">ylim</span>(<span class="dv">0</span>,<span class="dv">8000</span>) <span class="sc">+</span> <span class="fu">geom_line</span>(<span class="fu">aes</span>(Years, Pred), <span class="at">data =</span> Predictions1) <span class="sc">+</span> <span class="fu">geom_line</span>(<span class="fu">aes</span>(Years, Pred), <span class="at">data =</span> Predictions2, <span class="at">linetype =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 2 rows containing missing values (`geom_point()`).</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1 row containing missing values (`geom_line()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Fitting_logistic_curve_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Now try to figure out the best time lag as shown in the on-line example. </span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Hint: plot SS as it relates to the time lag value. SS is your sums of </span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co"># squares, so the value with the lowest sum of squares is the one you want. </span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Try lag values of 0 - 5. To include a lag, use the next function instead. </span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Note that there is now an additional parameter for lag t.</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>LogisticGrowthModelLag<span class="ot">&lt;-</span><span class="cf">function</span>(pars, Years, Numbers, <span class="at">t=</span><span class="dv">0</span>, <span class="at">ReturnResults=</span>F){</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  KK<span class="ot">&lt;-</span>pars[<span class="dv">1</span>]; rr<span class="ot">&lt;-</span>pars[<span class="dv">2</span>]; BB<span class="ot">&lt;-</span>pars[<span class="dv">3</span>]</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  TT<span class="ot">&lt;-</span>Years[<span class="dv">1</span>]<span class="sc">:</span>Years[<span class="fu">length</span>(Years)]</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  PP<span class="ot">&lt;-</span><span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">"numeric"</span>, <span class="at">length =</span> <span class="fu">length</span>(TT));</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  DD<span class="ot">&lt;-</span><span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">"numeric"</span>, <span class="at">length =</span> <span class="fu">length</span>(TT)); </span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  II<span class="ot">&lt;-</span>rr<span class="sc">*</span>BB<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>BB<span class="sc">/</span>KK)</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  PP[<span class="dv">1</span>]<span class="ot">&lt;-</span>BB<span class="sc">+</span>II</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">#implementing Logistic Growth for Years with no lagged Numbers data</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(t<span class="sc">&gt;</span><span class="dv">0</span>){</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>(t<span class="sc">+</span><span class="dv">1</span>)){ </span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>      DD[i<span class="dv">-1</span>]<span class="ot">&lt;-</span> rr<span class="sc">*</span>PP[i<span class="dv">-1</span>]<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>PP[i<span class="dv">-1</span>]<span class="sc">/</span>KK);</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>      PP[i]<span class="ot">&lt;-</span>PP[i<span class="dv">-1</span>] <span class="sc">+</span> DD[i<span class="dv">-1</span>]</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>  <span class="co">#implementing Lagged growth</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> (t<span class="sc">+</span><span class="dv">2</span>)<span class="sc">:</span><span class="fu">length</span>(PP)){ </span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>    DD[i<span class="dv">-1</span>]<span class="ot">&lt;-</span> rr<span class="sc">*</span>PP[i<span class="dv">-1</span>]<span class="sc">*</span>(<span class="dv">1</span><span class="sc">-</span>PP[i<span class="dv">-1</span><span class="sc">-</span>t]<span class="sc">/</span>KK); </span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>    PP[i]<span class="ot">&lt;-</span>PP[i<span class="dv">-1</span>] <span class="sc">+</span> DD[i<span class="dv">-1</span>]</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>  <span class="co">#print(PP) </span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>  Predictions<span class="ot">&lt;-</span><span class="fu">data.frame</span>(<span class="at">Years =</span> TT, <span class="at">Pred =</span> PP); Observations<span class="ot">&lt;-</span><span class="fu">data.frame</span>(Years, Numbers)</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>  Results<span class="ot">&lt;-</span><span class="fu">merge</span>(Predictions, Observations, <span class="at">by =</span> <span class="st">"Years"</span>)</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>  SS<span class="ot">&lt;-</span><span class="fu">sum</span>((Results<span class="sc">$</span>Numbers <span class="sc">-</span> Results<span class="sc">$</span>Pred)<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(ReturnResults<span class="sc">==</span>T){ <span class="fu">return</span>(<span class="fu">list</span>(Predictions, SS))} <span class="cf">else</span> {<span class="fu">return</span>(<span class="fu">ifelse</span>(<span class="fu">is.infinite</span>(SS), <span class="dv">10000000000</span>, SS))}</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a><span class="fu">LogisticGrowthModelLag</span>(OptPars1<span class="sc">$</span>par, <span class="at">t=</span><span class="dv">3</span>,Yrs, Data, <span class="at">ReturnResults=</span>T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
   Years         Pred
1   1903    0.9264883
2   1904    1.0729735
3   1905    1.2426160
4   1906    1.4390758
5   1907    1.6666051
6   1908    1.9301038
7   1909    2.2352565
8   1910    2.5886458
9   1911    2.9978936
10  1912    3.4718252
11  1913    4.0206589
12  1914    4.6562256
13  1915    5.3922222
14  1916    6.2445054
15  1917    7.2314313
16  1918    8.3742476
17  1919    9.6975471
18  1920   11.2297921
19  1921   13.0039190
20  1922   15.0580372
21  1923   17.4362351
22  1924   20.1895094
23  1925   23.3768358
24  1926   27.0664026
25  1927   31.3370279
26  1928   36.2797896
27  1929   41.9998947
28  1930   48.6188210
29  1931   56.2767662
30  1932   65.1354433
31  1933   75.3812615
32  1934   87.2289368
33  1935  100.9255750
34  1936  116.7552690
35  1937  135.0442496
36  1938  156.1666198
37  1939  180.5506912
38  1940  208.6859191
39  1941  241.1304043
40  1942  278.5188841
41  1943  321.5710768
42  1944  371.1001575
43  1945  428.0210365
44  1946  493.3579631
45  1947  568.2507935
46  1948  653.9590291
47  1949  751.8624446
48  1950  863.4567927
49  1951  990.3426863
50  1952 1134.2053549
51  1953 1296.7825730
52  1954 1479.8177352
53  1955 1684.9949017
54  1956 1913.8528027
55  1957 2167.6754551
56  1958 2447.3584494
57  1959 2753.2523534
58  1960 3084.9882786
59  1961 3441.2955571
60  1962 3819.8275401
61  1963 4217.0181645
62  1964 4627.9980060
63  1965 5046.6022290
64  1966 5465.5018160
65  1967 5876.4813051
66  1968 6270.8693448
67  1969 6640.1030097
68  1970 6976.3763500
69  1971 7273.2948096
70  1972 7526.4389775
71  1973 7733.7422313
72  1974 7895.6114652
73  1975 8014.7651322
74  1976 8095.8172321
75  1977 8144.6841282
76  1978 8167.9191361
77  1979 8172.0809512
78  1980 8163.2189742
79  1981 8146.5217069
80  1982 8126.1361650
81  1983 8105.1365485
82  1984 8085.6037441
83  1985 8068.7730403
84  1986 8055.2121226
85  1987 8045.0005886
86  1988 8037.8923087
87  1989 8033.4507631
88  1990 8031.1540810
89  1991 8030.4708544
90  1992 8030.9102644
91  1993 8032.0511701
92  1994 8033.5550140
93  1995 8035.1670798
94  1996 8036.7100344

[[2]]
[1] 41903227</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">LogisticGrowthModelLag</span>(OptPars2<span class="sc">$</span>par, <span class="at">t=</span><span class="dv">3</span>,Yrs, Data, <span class="at">ReturnResults=</span>T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
   Years           Pred
1   1903   1.457053e-25
2   1904   4.131800e-25
3   1905   1.171665e-24
4   1906   3.322518e-24
5   1907   9.421746e-24
6   1908   2.671748e-23
7   1909   7.576340e-23
8   1910   2.148441e-22
9   1911   6.092388e-22
10  1912   1.727633e-21
11  1913   4.899092e-21
12  1914   1.389248e-20
13  1915   3.939524e-20
14  1916   1.117140e-19
15  1917   3.167902e-19
16  1918   8.983298e-19
17  1919   2.547416e-18
18  1920   7.223770e-18
19  1921   2.048462e-17
20  1922   5.808874e-17
21  1923   1.647237e-16
22  1924   4.671110e-16
23  1925   1.324598e-15
24  1926   3.756195e-15
25  1927   1.065153e-14
26  1928   3.020482e-14
27  1929   8.565254e-14
28  1930   2.428870e-13
29  1931   6.887606e-13
30  1932   1.953135e-12
31  1933   5.538554e-12
32  1934   1.570581e-11
33  1935   4.453736e-11
34  1936   1.262957e-10
35  1937   3.581398e-10
36  1938   1.015586e-09
37  1939   2.879921e-09
38  1940   8.166664e-09
39  1941   2.315841e-08
40  1942   6.567087e-08
41  1943   1.862245e-07
42  1944   5.280813e-07
43  1945   1.497493e-06
44  1946   4.246478e-06
45  1947   1.204184e-05
46  1948   3.414735e-05
47  1949   9.683247e-05
48  1950   2.745902e-04
49  1951   7.786622e-04
50  1952   2.208071e-03
51  1953   6.261482e-03
52  1954   1.775584e-02
53  1955   5.035066e-02
54  1956   1.427806e-01
55  1957   4.048862e-01
56  1958   1.148144e+00
57  1959   3.255806e+00
58  1960   9.232455e+00
59  1961   2.617979e+01
60  1962   7.423134e+01
61  1963   2.104407e+02
62  1964   5.962782e+02
63  1965   1.687075e+03
64  1966   4.753548e+03
65  1967   1.323587e+04
66  1968   3.560916e+04
67  1969   8.633149e+04
68  1970   1.447620e+05
69  1971  -5.662549e+04
70  1972   3.310179e+05
71  1973  -6.028423e+06
72  1974   1.956649e+08
73  1975   3.256048e+09
74  1976  -2.535354e+11
75  1977  -3.733454e+14
76  1978   1.780857e+19
77  1979  -1.413675e+25
78  1980  -8.738152e+32
79  1981  -7.953561e+43
80  1982   3.453203e+59
81  1983   1.190154e+81
82  1984  2.535443e+110
83  1985  4.916395e+150
84  1986 -4.139045e+206
85  1987  1.200976e+284
86  1988           -Inf
87  1989            NaN
88  1990            NaN
89  1991            NaN
90  1992            NaN
91  1993            NaN
92  1994            NaN
93  1995            NaN
94  1996            NaN

[[2]]
[1] NaN</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>SS1<span class="ot">&lt;-</span>SS2<span class="ot">&lt;-</span><span class="fu">vector</span>(<span class="at">mode =</span> <span class="st">"numeric"</span>, <span class="at">length =</span> <span class="dv">7</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>OptPars1_list<span class="ot">&lt;-</span>OptPars2_list<span class="ot">&lt;-</span><span class="cn">NULL</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">6</span>){</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  OptPars1_list[[i<span class="sc">+</span><span class="dv">1</span>]]<span class="ot">&lt;-</span><span class="fu">try</span>(<span class="fu">optim</span>(OptPars1<span class="sc">$</span>par, <span class="at">fn=</span>LogisticGrowthModelLag, <span class="at">t=</span>i, <span class="at">method =</span> <span class="st">'L-BFGS-B'</span>, <span class="at">Years =</span> Yrs, <span class="at">Numbers =</span> Data, <span class="at">lower =</span> <span class="fu">c</span>(<span class="dv">2000</span>, <span class="dv">0</span>,<span class="fl">0.8</span>), <span class="at">upper =</span> <span class="fu">c</span>(<span class="dv">10000</span>, <span class="dv">1</span>,<span class="dv">100</span>), <span class="at">control =</span> <span class="fu">list</span>(<span class="at">maxit =</span> <span class="dv">50000</span>)), <span class="at">silent=</span>T)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  OptPars2_list[[i<span class="sc">+</span><span class="dv">1</span>]]<span class="ot">&lt;-</span><span class="fu">try</span>(<span class="fu">optim</span>(OptPars2<span class="sc">$</span>par, <span class="at">fn=</span>LogisticGrowthModelLag, <span class="at">t=</span>i, <span class="at">Years =</span> Yrs, <span class="at">Numbers =</span> Data, <span class="at">control =</span> <span class="fu">list</span>(<span class="at">maxit =</span> <span class="dv">50000</span>)),<span class="at">silent=</span>T)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>  SS1[i<span class="sc">+</span><span class="dv">1</span>]<span class="ot">&lt;-</span><span class="fu">try</span>(OptPars1_list[[i<span class="sc">+</span><span class="dv">1</span>]]<span class="sc">$</span>value<span class="sc">/</span><span class="dv">1000000</span>,<span class="at">silent=</span>T )</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>  SS2[i<span class="sc">+</span><span class="dv">1</span>]<span class="ot">&lt;-</span><span class="fu">try</span>(OptPars2_list[[i<span class="sc">+</span><span class="dv">1</span>]]<span class="sc">$</span>value<span class="sc">/</span><span class="dv">1000000</span>,<span class="at">silent=</span>T )</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>SS1 </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 42.51906 40.51695 38.37475 36.33096 34.87183 34.88024 37.08259</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>SS2 </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "3.42846793085808"                                                                      
[2] "7.36469949321783"                                                                      
[3] "Error in OptPars2_list[[i + 1]]$value : \n  $ operator is invalid for atomic vectors\n"
[4] "Error in OptPars2_list[[i + 1]]$value : \n  $ operator is invalid for atomic vectors\n"
[5] "Error in OptPars2_list[[i + 1]]$value : \n  $ operator is invalid for atomic vectors\n"
[6] "Error in OptPars2_list[[i + 1]]$value : \n  $ operator is invalid for atomic vectors\n"
[7] "Error in OptPars2_list[[i + 1]]$value : \n  $ operator is invalid for atomic vectors\n"</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Q - The time lag corresponding with the minimum SS is the best. What is time lag is that?</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="co">#That is, which would you choose if the best model by least squares (SS)?</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">lags=</span><span class="fu">c</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">6</span>), <span class="at">SS=</span>SS1) <span class="sc">%&gt;%</span> </span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">type =</span> <span class="st">'SS1'</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(<span class="fu">tibble</span>(<span class="at">lags=</span><span class="fu">c</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">6</span>), <span class="at">SS=</span><span class="fu">ifelse</span>(<span class="fu">grepl</span>(<span class="st">'Error'</span>, SS2), <span class="cn">NA_real_</span>, <span class="fu">as.numeric</span>(SS2))) <span class="sc">%&gt;%</span> </span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">type =</span> <span class="st">'SS2'</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(type) <span class="sc">%&gt;%</span> </span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(lags, SS)) <span class="sc">+</span> <span class="fu">geom_point</span>() <span class="sc">+</span> <span class="fu">facet_wrap</span>(<span class="sc">~</span>type)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in ifelse(grepl("Error", SS2), NA_real_, as.numeric(SS2)): NAs
introduced by coercion</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 5 rows containing missing values (`geom_point()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Fitting_logistic_curve_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Q - BUT, this is what happens with lag = 5. Why? (Compare plots with lag = 0 - 4)</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>OptPars<span class="ot">&lt;-</span><span class="cn">NULL</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>OptPars<span class="ot">&lt;-</span><span class="fu">optim</span>(<span class="fu">c</span>(<span class="dv">7500</span>,<span class="fl">0.5</span>,<span class="dv">1</span>), LogisticGrowthModelLag, <span class="at">t=</span><span class="dv">5</span>, <span class="at">Years =</span> Yrs, <span class="at">Numbers =</span> Data)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>Predictions<span class="ot">&lt;-</span><span class="fu">LogisticGrowthModelLag</span>(<span class="fu">c</span>(OptPars<span class="sc">$</span>par), <span class="at">t=</span><span class="dv">5</span>,Yrs, Data, <span class="at">ReturnResults=</span>T)[[<span class="dv">1</span>]]</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>Predictions2<span class="ot">&lt;-</span><span class="fu">LogisticGrowthModelLag</span>(<span class="fu">c</span>(OptPars1_list[[<span class="dv">6</span>]]<span class="sc">$</span>par), <span class="at">t=</span><span class="dv">6-1</span>,Yrs, Data, <span class="at">ReturnResults=</span>T)[[<span class="dv">1</span>]]</span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>L5 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(Yrs, Data) <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(Yrs, Data)) <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="at">shape =</span> <span class="st">"*"</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">5</span>) <span class="sc">+</span> <span class="fu">ylim</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">9000</span>) <span class="sc">+</span> <span class="fu">geom_line</span>(<span class="fu">aes</span>(Years, Pred), <span class="at">data =</span> Predictions, <span class="at">lty =</span> <span class="dv">2</span>) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">'Lag 5'</span>) <span class="sc">+</span> <span class="fu">geom_line</span>(<span class="fu">aes</span>(Years, Pred), <span class="at">data =</span> Predictions2, <span class="at">lty =</span> <span class="dv">1</span>)</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="fu">LogisticGrowthModelLag</span>(OptPars2<span class="sc">$</span>par, <span class="at">t=</span><span class="dv">5</span>,Yrs, Data, <span class="at">ReturnResults=</span>T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
   Years           Pred
1   1903   1.457053e-25
2   1904   4.131800e-25
3   1905   1.171665e-24
4   1906   3.322518e-24
5   1907   9.421746e-24
6   1908   2.671748e-23
7   1909   7.576340e-23
8   1910   2.148441e-22
9   1911   6.092388e-22
10  1912   1.727633e-21
11  1913   4.899092e-21
12  1914   1.389248e-20
13  1915   3.939524e-20
14  1916   1.117140e-19
15  1917   3.167902e-19
16  1918   8.983298e-19
17  1919   2.547416e-18
18  1920   7.223770e-18
19  1921   2.048462e-17
20  1922   5.808874e-17
21  1923   1.647237e-16
22  1924   4.671110e-16
23  1925   1.324598e-15
24  1926   3.756195e-15
25  1927   1.065153e-14
26  1928   3.020482e-14
27  1929   8.565254e-14
28  1930   2.428870e-13
29  1931   6.887606e-13
30  1932   1.953135e-12
31  1933   5.538554e-12
32  1934   1.570581e-11
33  1935   4.453736e-11
34  1936   1.262957e-10
35  1937   3.581398e-10
36  1938   1.015586e-09
37  1939   2.879921e-09
38  1940   8.166664e-09
39  1941   2.315841e-08
40  1942   6.567087e-08
41  1943   1.862245e-07
42  1944   5.280813e-07
43  1945   1.497493e-06
44  1946   4.246478e-06
45  1947   1.204184e-05
46  1948   3.414735e-05
47  1949   9.683247e-05
48  1950   2.745902e-04
49  1951   7.786622e-04
50  1952   2.208071e-03
51  1953   6.261482e-03
52  1954   1.775584e-02
53  1955   5.035067e-02
54  1956   1.427806e-01
55  1957   4.048865e-01
56  1958   1.148146e+00
57  1959   3.255825e+00
58  1960   9.232608e+00
59  1961   2.618102e+01
60  1962   7.424125e+01
61  1963   2.105204e+02
62  1964   5.969189e+02
63  1965   1.692224e+03
64  1966   4.794872e+03
65  1967   1.356633e+04
66  1968   3.822483e+04
67  1969   1.064332e+05
68  1970   2.863262e+05
69  1971   6.938150e+05
70  1972   1.156410e+06
71  1973  -5.455113e+05
72  1974   3.536788e+06
73  1975  -8.174416e+07
74  1976   5.474425e+09
75  1977  -9.104813e+11
76  1978   2.541112e+14
77  1979   3.451609e+16
78  1980  -2.966411e+19
79  1981  -5.912635e+23
80  1982   7.891325e+29
81  1983   1.751670e+38
82  1984  -1.085194e+49
83  1985   9.131881e+61
84  1986   6.604239e+77
85  1987   9.519960e+97
86  1988 -1.831540e+124
87  1989  7.821676e+158
88  1990  2.069371e+204
89  1991 -4.607124e+262
90  1992            Inf
91  1993            NaN
92  1994            NaN
93  1995            NaN
94  1996            NaN

[[2]]
[1] NaN</code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co">#...compared with lag = 3</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>OptPars<span class="ot">&lt;-</span><span class="cn">NULL</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>OptPars<span class="ot">&lt;-</span><span class="fu">optim</span>(<span class="fu">c</span>(<span class="dv">7500</span>,<span class="fl">0.5</span>,<span class="dv">1</span>), LogisticGrowthModelLag, <span class="at">t=</span><span class="dv">3</span>, <span class="at">Years =</span> Yrs, <span class="at">Numbers =</span> Data)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>Predictions<span class="ot">&lt;-</span><span class="fu">LogisticGrowthModelLag</span>(<span class="fu">c</span>(OptPars<span class="sc">$</span>par), <span class="at">t=</span><span class="dv">3</span>,Yrs, Data, <span class="at">ReturnResults=</span>T)[[<span class="dv">1</span>]]</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>Predictions2<span class="ot">&lt;-</span><span class="fu">LogisticGrowthModelLag</span>(<span class="fu">c</span>(OptPars1_list[[<span class="dv">4</span>]]<span class="sc">$</span>par), <span class="at">t=</span><span class="dv">4-1</span>,Yrs, Data, <span class="at">ReturnResults=</span>T)[[<span class="dv">1</span>]]</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>L3 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(Yrs,Data) <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(Yrs, Data)) <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="at">shape =</span> <span class="st">"*"</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">5</span>) <span class="sc">+</span> <span class="fu">ylim</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">9000</span>) <span class="sc">+</span> <span class="fu">geom_line</span>(<span class="fu">aes</span>(Years, Pred), <span class="at">data =</span> Predictions, <span class="at">lty =</span> <span class="dv">2</span>) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">'Lag 3'</span>) <span class="sc">+</span> <span class="fu">geom_line</span>(<span class="fu">aes</span>(Years, Pred), <span class="at">data =</span> Predictions2, <span class="at">lty =</span> <span class="dv">1</span>)</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="co">#...and no lag = 0</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>OptPars<span class="ot">&lt;-</span><span class="cn">NULL</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>OptPars<span class="ot">&lt;-</span><span class="fu">optim</span>(<span class="fu">c</span>(<span class="dv">7500</span>,<span class="fl">0.5</span>,<span class="dv">1</span>), LogisticGrowthModelLag, <span class="at">t=</span><span class="dv">0</span>, <span class="at">Years =</span> Yrs, <span class="at">Numbers =</span> Data)</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>Predictions<span class="ot">&lt;-</span><span class="fu">LogisticGrowthModelLag</span>(<span class="fu">c</span>(OptPars<span class="sc">$</span>par), <span class="at">t=</span><span class="dv">0</span>,Yrs, Data, <span class="at">ReturnResults=</span>T)[[<span class="dv">1</span>]]</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>Predictions2<span class="ot">&lt;-</span><span class="fu">LogisticGrowthModelLag</span>(<span class="fu">c</span>(OptPars1_list[[<span class="dv">1</span>]]<span class="sc">$</span>par), <span class="at">t=</span><span class="dv">1-1</span>,Yrs, Data, <span class="at">ReturnResults=</span>T)[[<span class="dv">1</span>]]</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>L0 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(Yrs, Data) <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(Yrs, Data)) <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="at">shape =</span> <span class="st">"*"</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">size =</span> <span class="dv">5</span>) <span class="sc">+</span> <span class="fu">ylim</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">9000</span>) <span class="sc">+</span> <span class="fu">geom_line</span>(<span class="fu">aes</span>(Years, Pred), <span class="at">data =</span> Predictions, <span class="at">lty =</span> <span class="dv">2</span>) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">'Lag 0'</span>) <span class="sc">+</span> <span class="fu">geom_line</span>(<span class="fu">aes</span>(Years, Pred), <span class="at">data =</span> Predictions2, <span class="at">lty =</span> <span class="dv">1</span>)</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a><span class="co">#Q - Which one fits the data best?</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>gridExtra<span class="sc">::</span><span class="fu">grid.arrange</span>(L5, L3, L0, <span class="at">ncol =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 1 row containing missing values (`geom_line()`).</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="Fitting_logistic_curve_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="take-home-messages" class="level3">
<h3 class="anchored" data-anchor-id="take-home-messages">TAKE HOME MESSAGES</h3>
<ul>
<li><p>The optimizer matters</p></li>
<li><p>The starting values matter</p></li>
<li><p>The biology matters</p></li>
</ul>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>